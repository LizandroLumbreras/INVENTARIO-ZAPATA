<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventario General Zapata</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
    h1, h2, h3 { color: #0d47a1; text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #0d47a1; color: white; }
    #loader { text-align: center; padding: 20px; }
    .spinner { margin:auto; width:40px; height:40px; border:4px solid #ccc; border-top:4px solid #0d47a1; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

    @media print {
      body { background: white; color: black; }
      button, #loader { display: none !important; }
      h2, h3 { color: black !important; }
      table { page-break-inside: avoid; }
      table, th, td { font-size: 11pt; }
      th { background: #e0e0e0 !important; color: black !important; }
      h2::before { content: "üßæ Inventario Impreso ‚Äî "; }
    }

    .fila-parpadeo-rojo { animation: parpadeoFila 1s infinite; background-color: #ffcccc; }
    @keyframes parpadeoFila { 0%, 100% { background-color: #ffcccc; } 50% { background-color: white; } }
  </style>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>Cargando inventario...</p>
  </div>

  <h1>INVENTARIO GENERAL ZAPATA</h1>
  <h2>üì¶ Inventario (con movimiento)</h2>

  <button onclick="window.print()" style="position:fixed; top:20px; right:20px; background:#0d47a1; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; z-index:999;">üñ®Ô∏è Imprimir</button>

  <button onclick="revisarInventario()" style="position:fixed; top:70px; right:20px; background:#388e3c; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; z-index:999;">üì§ Enviar a LobaZapata</button>

  <h3 id="totalGlobal" style="color:#0d47a1; text-align:left; margin-left:20px;">
    üí∞ TOTAL INVENTARIO ZAPATA: $0.00
  </h3>

  <div id="tablas"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const lineas = {
  "REYMA":[
    "365","355","357","364","363","7037","2178","14578","7016","7221","7689","7686","2096","1886","2097","1655","1901","7417","352","12146",
    "2409","2410","020013","2411","2188","2408","2190","3987","3988","3614","1347","020124","020126","020127","020003","055500500","2351","1349",
    "2350","450029","3864","3866","3865","3738","14579","020270","450065","750178","750175","750182","020167","020262","2397","2395","5853","4410",
    "5078","1502","1623","4395","1386413864","020066","5666","450083","020133","020073","7562","450006","7560","450010","450007","7011","020339",
    "450008","7013","450091","450090","141450","450086","450087","450101","450095","32322050","450079","450081","020319","020318","020297",
    "020306","020303","020300","020312","020310","450089","450100"
  ],
  "BIO PLAST":["7701200","7702200","8802200","8801200","9902200","9901200"],
  "JAGUAR":[
    "020051","020054","2033","2164","020053","1484","2161","1639","2162","020052","020055","1356","1355","290005","020052","1409","1486","1485","450053","450002"
  ],
  "BIGCOLA Y AGUA":[
    "060028","4451","250010","7506241","210010","7503033","7504033","7505033","14220","210004","3062","2382","3217","060007","7503000134803","7503000134506"
  ],
  "CONVERMEX":[
    "104104","106106","108108","110110","112112","114114","116116","132132","704704","706706","708708","712712","716716","732732","760760",
    "404404","406406","408408","410410","412412","414414","416416","516516","120120","7501431206038","7501825638728","7501825638742","020103","5283","5282"
  ],
  "BOLSA":[
    "4660","7702","13609","131825","132030","134060","142535","142540","144060","145070","147090","150100","150101","150102","150103","150104",
    "7501508800237","7503009154239","7503009154307","7503020773860","7503024644128","7503024644951"
  ]
};
const codigosExentos = ["2382","3062","3217","210004","7503000134506","7503000134803"];

let totalGlobalInventario = 0;

async function cargarDatos() {
  const entradasSnap = await db.collection("almacenes").doc("almacen_zapata").collection("entradas").get();
  const salidasSnap  = await db.collection("almacenes").doc("almacen_zapata").collection("salidas").get();
  const productosSnap = await db.collection("productos").get();

  const usados = new Set();

  // ‚ûú ENTRADAS: soporta arreglo 'articulos' y formato ra√≠z (codigo/cantidad)
  entradasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(it => usados.add(String(it.codigo)));
    } else if (data.codigo !== undefined) {
      usados.add(String(data.codigo));
    }
  });

  // ‚ûú SALIDAS: soporte h√≠brido tambi√©n (por si existe alg√∫n doc viejo)
  salidasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(it => usados.add(String(it.codigo)));
    } else if (data.codigo !== undefined) {
      usados.add(String(data.codigo));
    }
  });

  const codigosTodasLineas = Object.values(lineas).flat();
  const sinCategoria = [];
  for (const codigo of usados) {
    if (!codigosTodasLineas.includes(codigo)) sinCategoria.push(codigo);
  }

  for (const [linea, codigos] of Object.entries(lineas)) {
    await renderTabla(linea, codigos, productosSnap, entradasSnap, salidasSnap);
  }
  if (sinCategoria.length > 0) {
    await renderTabla("SIN CATEGOR√çA", sinCategoria, productosSnap, entradasSnap, salidasSnap, true);
  }

  document.getElementById("loader").style.display = "none";
}

async function renderTabla(nombre, codigos, productosSnap, entradasSnap, salidasSnap, mostrarSoloConMovimiento = false) {
  const productos = {};
  productosSnap.forEach(doc => {
    if (codigos.includes(doc.id)) {
      const base = doc.data()["Costo sin Impuesto"] || 0;
      const esExento = codigosExentos.includes(doc.id);
      const costoFinal = esExento ? base : base * 1.16;
      productos[doc.id] = {
        descripcion: doc.data().Concepto || "Sin descripci√≥n",
        impuesto: esExento ? "Exento" : "Con IVA",
        costo: costoFinal,
        entradas: 0,
        salidas: 0
      };
    }
  });

  // ‚úÖ ENTRADAS H√çBRIDO
  entradasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(item => {
        const codigo = String(item.codigo).trim();
        const cantidad = Number(item.cantidad) || 0;
        if (productos[codigo]) productos[codigo].entradas += cantidad;
      });
    } else if (data.codigo !== undefined) {
      const codigo = String(data.codigo).trim();
      const cantidad = Number(data.cantidad) || 0;
      if (productos[codigo]) productos[codigo].entradas += cantidad;
    }
  });

  // ‚úÖ SALIDAS H√çBRIDO
  salidasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(item => {
        const codigo = String(item.codigo).trim();
        const cantidad = Number(item.cantidad) || 0;
        if (productos[codigo]) productos[codigo].salidas += cantidad;
      });
    } else if (data.codigo !== undefined) {
      const codigo = String(data.codigo).trim();
      const cantidad = Number(data.cantidad) || 0;
      if (productos[codigo]) productos[codigo].salidas += cantidad;
    }
  });

  let filas = codigos
    .map(codigo => [codigo, productos[codigo]])
    .filter(([codigo, p]) => p !== undefined && (!mostrarSoloConMovimiento || p.entradas !== 0 || p.salidas !== 0));
  if (filas.length === 0) return;

  const formatter = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
  let totalInventarioCosteado = 0;

  let tablaHTML = `<h3>${nombre}</h3>`;
  tablaHTML += `<p style="text-align:right; font-weight:bold; color:#0d47a1;">üßæ Total Inventario Costeado: ${formatter.format(0)}</p>`;
  tablaHTML += `<table><thead><tr>
    <th>C√≥digo</th>
    <th>Descripci√≥n</th>
    <th>Costo</th>
    <th>Impuesto</th>
    <th>Inventario</th>
    <th>Inventario Costeado</th>
  </tr></thead><tbody>`;

  filas.forEach(([codigo, p]) => {
    const inventario = p.entradas - p.salidas;
    const totalCosteado = nombre === "BOLSA" ? p.costo * inventario * 25 : p.costo * inventario;
    totalInventarioCosteado += totalCosteado;
    totalGlobalInventario += totalCosteado;
    const claseFila = inventario < 0 ? 'fila-parpadeo-rojo' : '';
    tablaHTML += `<tr class="${claseFila}">
      <td>${codigo}</td>
      <td>${p.descripcion}</td>
      <td>${formatter.format(p.costo)}</td>
      <td>${p.impuesto}</td>
      <td><strong>${inventario}</strong></td>
      <td><strong>${formatter.format(totalCosteado)}</strong></td>
    </tr>`;
  });

  tablaHTML = tablaHTML.replace(formatter.format(0), formatter.format(totalInventarioCosteado));
  tablaHTML += "</tbody></table>";

  document.getElementById("tablas").innerHTML += tablaHTML;
  document.getElementById("totalGlobal").innerText =
    "üí∞ TOTAL INVENTARIO ZAPATA: " + formatter.format(totalGlobalInventario);
}

window.onload = cargarDatos;
</script>

<script>
  // Telegram LobaZapata
  const TELEGRAM_BOT_TOKEN = "8495270080:AAFBJ8Vxi6ZhqP6ghtJqMal9RZFz3YJBpo8";
  const TELEGRAM_CHAT_ID = "6617988297";
  const skusClave = [...new Set([
    "365","355","7016","7221","7689","7686","2096","1886","2097","1655","1901",
    "450079","450081",
    "060028","4451","250010","7506241","210010","7503033","7504033","7505033",
    "14220","210004","3062","2382","3217","7503000134803","7503000134506",
    "104104","106106","108108","110110","112112","114114","116116","132132",
    "704704","706706","708708","712712","716716","732732","760760",
    "404404","406406","408408","410410","412412","414414","416416","516516",
    "120120","5283","5282"
  ])];
</script>

<script>
<script>
async function revisarInventario() {
  const [entradasSnap, salidasSnap, productosSnap] = await Promise.all([
    db.collection("almacenes").doc("almacen_zapata").collection("entradas").get(),
    db.collection("almacenes").doc("almacen_zapata").collection("salidas").get(),
    db.collection("productos").get()
  ]);

  const conversionPorSKU = {
    "3062":72, "2382":42, "3217":80, "7503000134803":36, "7503000134506":90
  };

  const inventario = {};
  const descripciones = {};
  const descripcionesFijas = {
    "355":"REYMA 066 C/500","365":"REYMA 855 C/500","1655":"REYMA 9X9 LISA","1886":"REYMA 8X8 LISA",
    "2382":"AGUA GYM 12/1.5L","3062":"AGUA GYM 24/500ML","3217":"AGUA GYM 12/1L",
    "7503000134803":"AGUA GYM 6 LTS","7503000134506":"AGUA GYM 10 LTS"
  };

  productosSnap.forEach(doc => {
    const codigo = doc.id;
    const original = doc.data().Concepto || "Sin descripci√≥n";
    descripciones[codigo] = descripcionesFijas[codigo] || (original.length>60 ? original.slice(0,60)+"..." : original);
  });

  // ‚úÖ ENTRADAS H√çBRIDO
  entradasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(item => {
        const codigo = String(item.codigo).trim();
        const cantidad = Number(item.cantidad) || 0;
        if (!inventario[codigo]) inventario[codigo] = 0;
        inventario[codigo] += cantidad;
      });
    } else if (data.codigo !== undefined) {
      const codigo = String(data.codigo).trim();
      const cantidad = Number(data.cantidad) || 0;
      if (!inventario[codigo]) inventario[codigo] = 0;
      inventario[codigo] += cantidad;
    }
  });

  // ‚úÖ SALIDAS H√çBRIDO
  salidasSnap.forEach(doc => {
    const data = doc.data();
    if (Array.isArray(data.articulos)) {
      data.articulos.forEach(item => {
        const codigo = String(item.codigo).trim();
        const cantidad = Number(item.cantidad) || 0;
        if (!inventario[codigo]) inventario[codigo] = 0;
        inventario[codigo] -= cantidad;
      });
    } else if (data.codigo !== undefined) {
      const codigo = String(data.codigo).trim();
      const cantidad = Number(data.cantidad) || 0;
      if (!inventario[codigo]) inventario[codigo] = 0;
      inventario[codigo] -= cantidad;
    }
  });

  // üì¨ Helper Telegram con particionado
  async function enviarTelegram(texto) {
    const partes = [];
    let bloque = "";
    const LIM = 4000; // margen bajo 4096
    texto.split("\n").forEach(linea => {
      if ((bloque + linea + "\n").length > LIM) { partes.push(bloque); bloque = ""; }
      bloque += linea + "\n";
    });
    if (bloque) partes.push(bloque);

    for (let i = 0; i < partes.length; i++) {
      const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: partes[i] })
      });
      if (!res.ok) {
        const errorText = await res.text();
        console.error("Telegram error:", errorText);
        alert("‚ùå Error al enviar mensaje a Telegram.");
        return false;
      }
    }
    return true;
  }

  // üßæ Fecha/hora encabezado
  const ahora = new Date();
  const fechaStr = ahora.toLocaleString("es-MX", { hour12: false });

  // üß® 1) NEGATIVOS
  let msgNeg = `üö® INVENTARIOS NEGATIVOS ‚Äî ZAPATA\n${fechaStr}\n\n`;
  let hayNegativos = false;
  Object.keys(inventario).sort().forEach(codigo => {
    const ex = Number(inventario[codigo] || 0);
    if (ex < 0) {
      hayNegativos = true;
      const desc = descripciones[codigo] || "Sin descripci√≥n";
      const conv = conversionPorSKU[codigo];
      const enTarimas = conv ? ` | ${ (ex/conv).toFixed(2) } tarimas` : "";
      msgNeg += `‚ùó ${codigo} ‚Äî ${desc}\nExistencia: ${ex}${enTarimas}\n\n`;
    }
  });
  if (!hayNegativos) msgNeg += "‚úÖ Sin negativos.\n";

  // üìâ 2) BAJO M√çNIMO
  let msgMin = `üìâ BAJO M√çNIMO ‚Äî ZAPATA\n${fechaStr}\n\n`;
  let hayBajo = false;
  Object.entries(minimosPorSKU).forEach(([codigo, minimo]) => {
    const ex = Number(inventario[codigo] || 0);
    if (ex <= minimo) {
      hayBajo = true;
      const desc = descripciones[codigo] || "Sin descripci√≥n";
      const faltante = Math.max(0, minimo - ex);

      // Piezas y tarimas (si aplica)
      const conv = conversionPorSKU[codigo];
      const exTar = conv ? (ex/conv).toFixed(2) : null;
      const minTar = conv ? (minimo/conv).toFixed(2) : null;
      const falTar = conv ? (faltante/conv).toFixed(2) : null;

      msgMin += `‚ö†Ô∏è ${codigo} ‚Äî ${desc}\n` +
                `Existencia: ${ex}${exTar ? ` (${exTar} tarimas)` : ""}\n` +
                `M√≠nimo: ${minimo}${minTar ? ` (${minTar} tarimas)` : ""}\n` +
                `Faltante para m√≠nimo: ${faltante}${falTar ? ` (${falTar} tarimas)` : ""}\n\n`;
    }
  });
  if (!hayBajo) msgMin += "‚úÖ Todos por arriba de m√≠nimos configurados.\n";

  // üì¶ 3) (Opcional) Resumen de SKUs clave con divisi√≥n a tarimas (tu bloque original)
  let msgClave = `üì¶ Inventario actual ‚Äî SKUs clave\n${fechaStr}\n\n`;
  skusClave.forEach(codigo => {
    // solo mostrar si tenemos una descripci√≥n fuerte; puedes quitar esta l√≠nea si quieres listar todos
    if (!descripcionesFijas[codigo]) return;
    const existencia = Number(inventario[codigo] ?? 0);
    const descripcion = descripcionesFijas[codigo];
    const divisor = conversionPorSKU[codigo];

    if (divisor && divisor > 0) {
      const tarimas = existencia / divisor;
      msgClave += `‚úÖ ${codigo} - ${descripcion} entre ${divisor}\n` +
                  `Existencia: ${existencia} / ${divisor} = ${tarimas.toFixed(2)} tarimas\n\n`;
    } else {
      msgClave += `‚úÖ ${codigo} - ${descripcion}\nExistencia: ${existencia}\n\n`;
    }
  });

  // üöÄ Env√≠a en 2‚Äì3 bloques
  const ok1 = await enviarTelegram(msgNeg);
  const ok2 = await enviarTelegram(msgMin);
  const ok3 = await enviarTelegram(msgClave);

  if (ok1 && ok2 && ok3) {
    alert("‚úÖ Reportes de NEGATIVOS, M√çNIMOS y SKUs clave enviados a LobaZapata.");
  }
}
</script>
  // ‚öôÔ∏è M√≠nimos por SKU (en piezas/unidades del SKU)
  // EDITA estos valores seg√∫n tus pol√≠ticas de reabasto.
  const minimosPorSKU = {
    "365": 10,
    "355": 10,
    "1655": 5,
    "1886": 5,
    "2382": 84,        // Agua 12/1.5L (piezas). Si quieres m√≠nimo en tarimas ajusta con conversionPorSKU
    "3062": 144,       // Agua 24/500ml
    "3217": 80,        // Agua 12/1L
    "7503000134803": 72, // Agua 6 Lts
    "7503000134506": 90  // Agua 10 Lts
    // ... a√±ade los que necesites
  };
</script>

</script>
</body>
</html>
