<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Inventario – Almacén Zapata</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}
h2{
  color:#00416A;
  text-align:center;
}
table{
  width:100%;
  border-collapse:collapse;
  background:white;
}
th,td{
  border:1px solid #ccc;
  padding:8px;
  text-align:center;
  font-size:14px;
}
th{
  background:#00416A;
  color:white;
}
.proveedor{
  background:linear-gradient(to right,#00416A,#0c6cbd);
  color:white;
  font-weight:bold;
  font-size:16px;
}
.positivo{color:green;font-weight:bold;}
.negativo{color:red;font-weight:bold;}
</style>
</head>

<body>

<h2>Inventario Costeado – Almacén Zapata</h2>

<table>
<thead>
<tr>
  <th>Código</th>
  <th>Descripción</th>
  <th>Inventario</th>
  <th>Costo s/IVA</th>
  <th>Total</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, query, where,
  getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= VARIABLES ================= */
let productos = {};
let base = {};
let entradas = {};
let salidas = {};

let okP=false, okB=false, okE=false, okS=false;

/* MISMA FECHA DE CORTE */
const fechaCorte = new Date("2025-11-24T00:00:00");

/* ================= UTIL ================= */
function norm(c){
  return (c||"").toString().trim().padStart(12,"0");
}

/* ================= 1. PRODUCTOS ACTIVOS ================= */
async function cargarProductos(){
  const q = query(collection(db,"productos"), where("activo","==",true));
  const snap = await getDocs(q);

  snap.forEach(d=>{
    const x=d.data();
    if(!x.proveedor) return;

    const c = norm(x.codigoBarra || x.codigo);
    productos[c] = {
      descripcion: x.concepto || x.descripcion || "-",
      proveedor: x.proveedor,
      costo: Number(x.costoSinImpuesto || 0)
    };
  });

  okP=true;
  intentar();
}

/* ================= 2. INVENTARIO BASE ================= */
async function cargarBase(){
  const snap = await getDocs(
    collection(db,"almacenes/almacen_zapata/inventario_base")
  );

  snap.forEach(d=>{
    base[norm(d.id)] = Number(d.data().existencia || 0);
  });

  okB=true;
  intentar();
}

/* ================= 3. ENTRADAS ================= */
function cargarEntradas(){
  onSnapshot(
    collection(db,"almacenes/almacen_zapata/entradas"),
    snap=>{
      entradas={};

      snap.forEach(d=>{
        const x=d.data();
        const f = x.fecha?.toDate?.() || new Date(x.fecha);
        if(f<=fechaCorte) return;

        (x.productos||[]).forEach(i=>{
          const c=norm(i.codigoBarra||i.codigobarras||i.codigo);
          entradas[c]=(entradas[c]||0)+Number(i.cantidad||0);
        });

        (x.conceptos_detalle||[]).forEach(i=>{
          const c=norm(i.codigo||i.productoId);
          entradas[c]=(entradas[c]||0)+Number(i.cantidad||0);
        });
      });

      okE=true;
      intentar();
    }
  );
}

/* ================= 4. SALIDAS ================= */
function cargarSalidas(){
  onSnapshot(
    collection(db,"almacenes/almacen_zapata/salidas1.0"),
    snap=>{
      salidas={};

      snap.forEach(d=>{
        const x=d.data();
        const f = x.timestamp?.toDate?.() || new Date(x.timestamp);
        if(f<=fechaCorte) return;

        (x.articulos||[]).forEach(i=>{
          const c=norm(i.codigoBarra||i.codigobarra||i.codigo);
          salidas[c]=(salidas[c]||0)+Number(i.cantidad||0);
        });
      });

      okS=true;
      intentar();
    }
  );
}

/* ================= DIBUJAR ================= */
function intentar(){
  if(okP && okB && okE && okS){
    dibujar();
  }
}

function dibujar(){
  const t=document.getElementById("tabla");
  t.innerHTML="";

  const porProveedor={};

  Object.keys(productos).forEach(c=>{
    const p=productos[c];
    const existencia=(base[c]||0)+(entradas[c]||0)-(salidas[c]||0);

    if(existencia===0) return;

    const total = existencia * p.costo;

    if(!porProveedor[p.proveedor]) porProveedor[p.proveedor]=[];
    porProveedor[p.proveedor].push({
      c, d:p.descripcion, e:existencia, cost:p.costo, tot:total
    });
  });

  Object.keys(porProveedor).sort().forEach(prov=>{
    t.innerHTML+=`<tr class="proveedor"><td colspan="5">${prov}</td></tr>`;

    porProveedor[prov].sort((a,b)=>a.c.localeCompare(b.c));

    porProveedor[prov].forEach(i=>{
      t.innerHTML+=`
      <tr>
        <td>${i.c}</td>
        <td>${i.d}</td>
        <td class="${i.e<0?'negativo':'positivo'}">${i.e}</td>
        <td>$${i.cost.toFixed(2)}</td>
        <td>$${i.tot.toFixed(2)}</td>
      </tr>`;
    });
  });
}

/* ================= INIT ================= */
await cargarProductos();
await cargarBase();
cargarEntradas();
cargarSalidas();
</script>

</body>
</html>
