<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Existencia – Almacén Zapata (COSTEADO)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
 body{
   font-family: Arial, sans-serif;
   background:#f4f4f4;
   padding:20px;
 }
 h2{
   color:#00416A;
   font-size:26px;
   margin-bottom:5px;
 }

 #totalesBox{
   text-align:right;
   font-size:18px;
   font-weight:bold;
   color:#00416A;
   margin-bottom:20px;
 }

 table{
   width:100%;
   border-collapse:collapse;
   background:white;
   margin-top:15px;
 }
 th,td{
   border:1px solid #ccc;
   padding:10px;
   text-align:center;
   font-size:15px;
 }
 th{
   background:#00416A;
   color:white;
 }
 .positivo{ color:green; font-weight:bold; }
 .negativo{ color:red; font-weight:bold; }
</style>
</head>

<body>

<h2>Existencia Total – Almacén Zapata (COSTEADO SIN IVA)</h2>

<div id="totalesBox">Calculando…</div>

<table>
<thead>
   <tr>
     <th>Código</th>
     <th>Descripción</th>
     <th>Existencia</th>
     <th>Costo s/IVA</th>
     <th>Total</th>
   </tr>
</thead>

<tbody id="tablaExistencia"></tbody>
</table>

<script type="module">

// ---------------------------------------------------------------------
// FIREBASE
// ---------------------------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, query, where,
  getDocs, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabla = document.getElementById("tablaExistencia");
const totalesBox = document.getElementById("totalesBox");

// ---------------------------------------------------------------------
// VARIABLES
// ---------------------------------------------------------------------
let productos = {};
let inventarioBase = {};
let entradasNuevas = {};
let salidasNuevas = {};

let productosListos = false;
let baseLista = false;
let entradasListas = false;
let salidasListas = false;

const fechaCorte = new Date("2025-11-24T00:00:00");

// ---------------------------------------------------------------------
// NORMALIZADOR
// ---------------------------------------------------------------------
function normCodigo(cod){
  if(!cod) return "";
  return cod.toString().trim().padStart(12, "0");
}

// ---------------------------------------------------------------------
// 1. PRODUCTOS ACTIVOS + COSTO
// ---------------------------------------------------------------------
async function cargarProductos(){

  const q = query(collection(db, "productos"), where("activo", "==", true));
  const snap = await getDocs(q);

  snap.forEach(docu => {
    const d = docu.data();
    if(!d.proveedor || d.proveedor.trim() === "") return;

    const codigo = normCodigo(d.codigoBarra || d.codigo || "");

    productos[codigo] = {
      proveedor: d.proveedor,
      descripcion: d.concepto || d.descripcion || "-",
      costo: Number(d.costoSinImpuesto || 0)
    };
  });

  productosListos = true;
  intentarDibujar();
}

// ---------------------------------------------------------------------
// 2. INVENTARIO BASE
// ---------------------------------------------------------------------
async function cargarInventarioBase(){

  const ref = collection(db, "almacenes/almacen_zapata/inventario_base");
  const snap = await getDocs(ref);

  snap.forEach(docu => {
    const codigo = normCodigo(docu.id);
    inventarioBase[codigo] = docu.data().existencia || 0;
  });

  baseLista = true;
  intentarDibujar();
}

// ---------------------------------------------------------------------
// 3 y 4. ENTRADAS Y SALIDAS SE MANTIENEN IGUAL
// ---------------------------------------------------------------------
function cargarEntradas(){
  const ref = collection(db, "almacenes/almacen_zapata/entradas");
  onSnapshot(ref, snap => {
    entradasNuevas = {};
    snap.forEach(docu => {
      const data = docu.data();
      const fecha = data.fecha?.toDate?.() || new Date(data.fecha);
      if(fecha <= fechaCorte) return;

      if(Array.isArray(data.productos)){
        data.productos.forEach(item=>{
          const codigo = normCodigo(item.codigoBarra || item.codigobarras || item.codigo || "");
          const cant = Number(item.cantidad||0);
          if(!entradasNuevas[codigo]) entradasNuevas[codigo]=0;
          entradasNuevas[codigo]+=cant;
        });
      }

      if(Array.isArray(data.conceptos_detalle)){
        data.conceptos_detalle.forEach(item=>{
          const codigo = normCodigo(item.codigo || item.productoId || "");
          const cant = Number(item.cantidad||item.cantidadTotal||0);
          if(!entradasNuevas[codigo]) entradasNuevas[codigo]=0;
          entradasNuevas[codigo]+=cant;
        });
      }
    });
    entradasListas = true;
    intentarDibujar();
  });
}

function cargarSalidas(){
  const ref = collection(db, "almacenes/almacen_zapata/salidas1.0");
  onSnapshot(ref, snap => {
    salidasNuevas = {};
    snap.forEach(docu => {
      const data = docu.data();
      const fecha = data.timestamp?.toDate?.() || new Date(data.timestamp);
      if(fecha <= fechaCorte) return;

      if(Array.isArray(data.articulos)){
        data.articulos.forEach(item=>{
          const codigo = normCodigo(item.codigoBarra || item.codigobarra || item.codigo || "");
          const cant = Number(item.cantidad||0);
          if(!salidasNuevas[codigo]) salidasNuevas[codigo]=0;
          salidasNuevas[codigo]+=cant;
        });
      }
    });
    salidasListas = true;
    intentarDibujar();
  });
}

// ---------------------------------------------------------------------
// 5. MOSTRAR INFORMACIÓN + FILTRO + MULTIPLICADOR 25
// ---------------------------------------------------------------------
function intentarDibujar(){
  if(!productosListos || !baseLista || !entradasListas || !salidasListas) return;
  dibujar();
}

function esBolsaEspecial(desc){
  desc = desc.toUpperCase();
  return (
    desc.includes("BOLSA CAMISETA NEGRA") ||
    desc.includes("BOLSA CAMISETA POLIPAPEL") ||
    desc.includes("BOLSA CAMISETA POLISEDA") ||
    desc.includes("BOLSA NATURAL") ||
    desc.includes("BOLSA ROLLO")
  );
}

function dibujar(){

  tabla.innerHTML = "";

  let porProveedor = {};
  let totalPiezas = 0;
  let totalDinero = 0;

  Object.keys(productos).forEach(codigo => {

    const p = productos[codigo];

    const base = inventarioBase[codigo] || 0;
    const ent  = entradasNuevas[codigo] || 0;
    const sal  = salidasNuevas[codigo] || 0;

    const existencia = base + ent - sal;

    // ✔ filtro: NO mostrar existencia 0
    if(existencia === 0) return;

    let costoUnit = p.costo;

    // ✔ multiplicador ×25 para bolsas
    if(esBolsaEspecial(p.descripcion)){
      costoUnit = costoUnit * 25;
    }

    const total = existencia * costoUnit;

    totalPiezas += existencia;
    totalDinero += total;

    if(!porProveedor[p.proveedor]) porProveedor[p.proveedor] = [];

    porProveedor[p.proveedor].push({
      codigo,
      descripcion: p.descripcion,
      existencia,
      costo: costoUnit,
      total
    });

  });

  // Mostrar totales
  totalesBox.innerHTML = `
    Total piezas: <b>${totalPiezas}</b> — Total dinero: 
    <b>$${totalDinero.toFixed(2)}</b>
  `;

  // Mostrar tabla por proveedor
  Object.keys(porProveedor).sort().forEach(prov => {

    tabla.innerHTML += `
      <tr>
        <td colspan="5"
            style="background:linear-gradient(to right,#00416A,#0c6cbd);
                   color:white;font-size:20px;font-weight:bold;">
            ${prov}
        </td>
      </tr>
    `;

    porProveedor[prov].sort((a,b)=> a.codigo.localeCompare(b.codigo));

    porProveedor[prov].forEach(p => {

      tabla.innerHTML += `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.descripcion}</td>
          <td class="${p.existencia < 0 ? "negativo" : "positivo"}">${p.existencia}</td>
          <td>$${p.costo.toFixed(2)}</td>
          <td>$${p.total.toFixed(2)}</td>
        </tr>
      `;

    });

    tabla.innerHTML += `<tr><td colspan="5" style="height:8px;background:#eaeaea;"></td></tr>`;
  });

}

// ---------------------------------------------------------------------
// EJECUTAR
// ---------------------------------------------------------------------
await cargarProductos();
await cargarInventarioBase();
cargarEntradas();
cargarSalidas();

</script>

</body>
</html>
